name: CI
on:
    push:
        branches:
            - main
            - master
    pull_request:
        branches:
            - main
            - master

jobs:
    build_kit:
        name: Build kit
        runs-on: ubuntu-latest
        steps:
            - name: Fetch latest code
              uses: actions/checkout@v2
              with:
                  repository: darwinia-network/darwinia-kit
                  ref: cd17822e81f9f5346becd3ebd05f85e03a1e6832
            - name: Install Rust nightly-2021-08-03 toolchain
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: nightly-2021-08-03
                  default: true
            - name: Build
              uses: actions-rs/cargo@v1
              with:
                  command: build
                  args: --manifest-path ci-bot/Cargo.toml
            - name: Compress kit
              run: mv ci-bot avoid-same-name && cp target/debug/ci-bot . && tar cf kit.tar.zst ci-bot -I pzstd
            - name: Upload kit
              uses: actions/upload-artifact@v2
              with:
                  name: kit
                  path: kit.tar.zst
    build_and_test_pangolin:
        name: Build and test node
        runs-on: ubuntu-latest
        steps:
            - name: Fetch latest code
              uses: actions/checkout@v2
            - name: Install Rust nightly-2021-08-03 toolchain
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: nightly-2021-08-03
                  default: true
            - name: Build
              uses: actions-rs/cargo@v1
              with:
                  command: build
                  args: --manifest-path .maintain/check-default-features/Cargo.toml
            - name: Test
              uses: actions-rs/cargo@v1
              with:
                  command: test
                  args: --manifest-path .maintain/check-default-features/Cargo.toml
            - name: Compress node
              run: |
                  cp .maintain/check-default-features/target/debug/check-default-features . \
                  && tar cf node.tar.zst check-default-features -I pzstd
            - name: Upload node
              uses: actions/upload-artifact@v2
              with:
                  name: node
                  path: node.tar.zst
    check_default_features:
        name: Check default features
        runs-on: ubuntu-latest
        needs: [build_kit]
        steps:
            - name: Fetch latest code
              uses: actions/checkout@v2
            - name: Download kit
              uses: actions/download-artifact@v2
              with:
                  name: kit
            - name: Uncompress kit
              run: tar xf kit.tar.zst -I pzstd
            - name: Run checker
              run: ./ci-bot default-features --project-dir ../darwinia-common
    check_storage_prefixes:
        name: Check storage prefix
        runs-on: ubuntu-latest
        needs: [build_kit, build_and_test_pangolin]
        steps:
            - name: Download kit
              uses: actions/download-artifact@v2
              with:
                  name: kit
            - name: Download node
              uses: actions/download-artifact@v2
              with:
                  name: node
            - name: Uncompress kit and node
              run: tar xf kit.tar.zst -I pzstd && tar xf node.tar.zst -I pzstd
            - name: Run checker
              run: ./ci-bot storage-prefix --chain pangolin --exec drml
