// This file is part of Darwinia.
//
// Copyright (C) 2018-2021 Darwinia Network
// SPDX-License-Identifier: GPL-3.0
//
// Darwinia is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Darwinia is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Darwinia. If not, see <https://www.gnu.org/licenses/>.

//! Tests for ethereum-backing.

// --- paritytech ---
use frame_support::{assert_err, assert_noop, assert_ok, traits::Currency, WeakBoundedVec};
use sp_runtime::{traits::Dispatchable, AccountId32};
// --- darwinia-network ---
use crate::{
	mock::{Call, *},
	pallet::*,
};
use darwinia_bridge_ethereum::EthereumRelayHeaderParcel;
use darwinia_relay_primitives::Sign;
use darwinia_staking::{RewardDestination, StakingBalance, StakingLedger, TimeDepositItem};
use darwinia_support::balance::*;
use ethereum_primitives::receipt::EthereumReceiptProof;

#[test]
fn genesis_config_works() {
	ExtBuilder::default().build().execute_with(|| {
		assert_eq!(EthereumBacking::pot::<Ring>(), 20000000000000);
		assert_eq!(EthereumBacking::pot::<Kton>(), 5000000000000);
	});
}

#[test]
fn verify_parse_token_redeem_proof() {
	ExtBuilder::default()
		.build()
		.execute_with(|| {
			// https://ropsten.etherscan.io/tx/0x1d3ef601b9fa4a7f1d6259c658d0a10c77940fa5db9e10ab55397eb0ce88807d
			let test_receipt_proof_thing =  serde_json::from_str::<TestReceiptProofThing>(r#"{
				"header": {
					"difficulty": "0x1eba84a4",
					"extraData": "0xde830207028f5061726974792d457468657265756d86312e34312e30826c69",
					"gasLimit": "0x7a121d",
					"gasUsed": "0xe921d",
					"hash": "0xabf627ce77d9f92a40f34e3cace721c3f089000dae820d00d3e99314c263a0c3",
					"logsBloom": "0x00000000008000000000002000000004400000000000001000000000000000002000000000080000000010000040000000000001000000400000000000000000000000000000000011000008000000000210000000000000400000000000000000000000020000008104000000080800080000000000000000000030000000400004000000000001000000040000008000000002004000810010000000200000002000000000200000000000800000040010000400000200080000000000000000000402000000000200010000040000000001000001200800000000000020000000000000000000000000000010010000800000000080010000000004000000",
					"miner": "0xad87c0e80ab5e13f15757d5139cc6c6fcb823be3",
					"mixHash": "0xdeadf98810a6ccfb8d00e8f6bc7ad7f5d62d5a42760c0d9db8a549df76697704",
					"nonce": "0xbf7326c26c57c69c",
					"number": "0x8361d5",
					"parentHash": "0xd55ce7660d0161c38b34015ce5468e1661f1c77865f23415e246ac9ccf7b2b22",
					"receiptsRoot": "0xfdb6d2cdb6bc9e78711a008b2912e62db28de4520dfcd49bd6f7086718c5d0cb",
					"sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
					"size": "0xc0f",
					"stateRoot": "0xf108de6fa8fbf18e795cb3e1911d32e7d26178a69bb2f365662c8cba58bd7159",
					"timestamp": "0x5f50b3e0",
					"totalDifficulty": "0x6fa00a3a842464",
					"transactions": [],
					"transactionsRoot": "0x6cf40dbc3f8ce55ffc0f863a65ffd285da787b77af952c319e2577c5ab278a3a",
					"uncles": []
				},
				"receipt_proof": {
					"index": "0x12",
					"proof": "0xf90654f90651b873f871a08905d6a9a81124e73b632ff8e0ac638331d4aa0f89bc5b296b5132ab1e6db295a0296366ce16b627f71457cefa27e7cbd6aa3f13ce1e2225bb06236089d5363667808080808080a0c73f3d756add498b44b70ae5d5b917fcc8c3adb72f10cc5cd245a862d9a2a17d8080808080808080b873f871a039af78839760433d410ab11ef453e8656451a51575e0be71fa7a72b54bfc296aa098d3ce8768b102d89494e55dde408e28d1ec148affca70a955d2b30bd9fcf008a078eacce43297ddfa328b51d92ccd8666abf1df855cef7ab3b1f4dbd16874ff658080808080808080808080808080b90564f9056120b9055df9055a01830e921db9010000000000008000000000002000000004400000000000001000000000000000000000000000000000000010000000000000000000000000400000000000000000000000000000000010000008000000000010000000000000000000000000000000000000020000000104000000000800080000000000000000000010000000400000000000000001000000000000008000000002004000000010000000200000000000000000000000000000800000000000000000000200080000000000000000000002000000000000000000040000000001000000000800000000000020000000000000000000000000000010000000000000000080000000000000000000f9044ff89b94b52fbe2b925ab79a821b261c82c5ba0814aaa5e0f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000cc5e48beb33b83b8bd0d9d9a85a8f6a27c51f5c5a000000000000000000000000049262b932e439271d05634c32978294c7ea15d0ca00000000000000000000000000000000000000000000000001121d33597384000f89b94b52fbe2b925ab79a821b261c82c5ba0814aaa5e0f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000cc5e48beb33b83b8bd0d9d9a85a8f6a27c51f5c5a00000000000000000000000007f5b598827359939606b3525712fb124a1c7851da00000000000000000000000000000000000000000000000001bc16d674ec80000f87a94b52fbe2b925ab79a821b261c82c5ba0814aaa5e0f842a0cc16f5dbb4873280815c1ee09dbd06736cffcc184412cf7a71a0fdb75d397ca5a000000000000000000000000049262b932e439271d05634c32978294c7ea15d0ca00000000000000000000000000000000000000000000000001121d33597384000f89b94b52fbe2b925ab79a821b261c82c5ba0814aaa5e0f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa000000000000000000000000049262b932e439271d05634c32978294c7ea15d0ca00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000001121d33597384000f8fc9449262b932e439271d05634c32978294c7ea15d0cf863a0c9dcda609937876978d7e0aa29857cb187aea06ad9e843fd23fd32108da73f10a0000000000000000000000000b52fbe2b925ab79a821b261c82c5ba0814aaa5e0a0000000000000000000000000cc5e48beb33b83b8bd0d9d9a85a8f6a27c51f5c5b8800000000000000000000000000000000000000000000000001121d3359738400000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000020e44664996ab7b5d86c12e9d5ac3093f5b2efc9172cb7ce298cd6c3c51002c318f8fc94b52fbe2b925ab79a821b261c82c5ba0814aaa5e0f863a09bfafdc2ae8835972d7b64ef3f8f307165ac22ceffde4a742c52da5487f45fd1a0000000000000000000000000cc5e48beb33b83b8bd0d9d9a85a8f6a27c51f5c5a000000000000000000000000049262b932e439271d05634c32978294c7ea15d0cb8800000000000000000000000000000000000000000000000001121d3359738400000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000020e44664996ab7b5d86c12e9d5ac3093f5b2efc9172cb7ce298cd6c3c51002c318",
					"header_hash": "0xabf627ce77d9f92a40f34e3cace721c3f089000dae820d00d3e99314c263a0c3"
				},
				"mmr_proof": {
					"member_leaf_index": 8610261,
					"last_leaf_index": 8610261,
					"proof": [
						"0x36f3d834cbe12a5a20b063c432b88f5506bdce03b93fa3aa035a5d82fd50177c",
						"0x541f71c116b054b7cf0f35461b41abdc0bc6e461ae54862c8dc3af6b48742a35",
						"0x095f1b66aed2db73567706e227981454a80a442aa69b00aedaef787fd5401a78",
						"0x942cfd846d464575b520554dd07fd4b07ba2cb8bee6234530db1c1b3a69e1c50",
						"0x3174f9fdf5f7c9df6ac422a0a9e2aec05ccb7968bb1ff19b6cc0b64fbc930e77",
						"0x5624f44ff885dcdc971303281bb76c6b6a957a6cc2d244b30f736fc6220f9b89",
						"0xa3adc2ee02f7ceda7e63df8fb58094769afd3f7657c8f9f45cdc69d5c868b468",
						"0xe588926a1643dc04b197a7ed30dd47d42d35fdb01f7aa80b2e293b058c11c6a1",
						"0x25d7ac48be9565512424ef559b7e0ec7a91bfe9b57440913712a174e35eb47d8",
						"0xf4505f26b22ae59f5560003a68a66e8c07a9f77f212e05ea060018bd0acd1f55",
						"0xd55ce7660d0161c38b34015ce5468e1661f1c77865f23415e246ac9ccf7b2b22"
					]
				}
			}"#).unwrap();
			let test_receipt_proof_thing = (test_receipt_proof_thing.header, test_receipt_proof_thing.receipt_proof, test_receipt_proof_thing.mmr_proof);
			let relay_header_parcel = serde_json::from_str::<EthereumRelayHeaderParcel>(r#"{
				"header": {
					"difficulty": "0x1eba84a4",
					"extraData": "0x6c6f746f706f6f6c",
					"gasLimit": "0x7a1200",
					"gasUsed": "0x667f8a",
					"hash": "0xd04a94f4ec0a29f53b40fb13a660b680c8b66ccbb4e864a3727535f667a07bb1",
					"logsBloom": "0x00000000000000000000000000000000000000000000000000800000000000000000000000010000000000000000004000000000000000020000010000000000001000000000000000000008000000000001000000000000000000000000000000000000020000000000000000000800000000000000000000000010000000400000000000001000000000000000000000000000001000000000100000000000000000000000000000000000000000000000000000800000004000000080000000080002000008000000000040000000200200000000000002000000000020000000010000000000000000000000000000000000000000000000000000000000",
					"miner": "0x52351e33b3c693cc05f21831647ebdab8a68eb95",
					"mixHash": "0x46b0cc502bfed25a8700f53d6695eeed640b80218855b1dd5479c98a7b0e3e58",
					"nonce": "0x0011000003407250",
					"number": "0x8361d6",
					"parentHash": "0xabf627ce77d9f92a40f34e3cace721c3f089000dae820d00d3e99314c263a0c3",
					"receiptsRoot": "0x2bbd8af877b41e2cdff6e69dc100c69b061c874c3898e073ac24648ac9cd7d02",
					"sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
					"size": "0x195fa",
					"stateRoot": "0x20a368875c1aa9f46a7be4de7b470b92440684d0d74416b77ace846a31d57ce6",
					"timestamp": "0x5f50b3ef",
					"totalDifficulty": "0x6fa00a593ea908",
					"transactions": [],
					"transactionsRoot": "0xc6957c52dcac0eb2bda32765cc7c2b13406cf040021ea5caa5ba974d7a81fc95",
					"uncles": []
				  },
				"parent_mmr_root": "0x95866493e3fd63b6a19c7815cc5cecaae57d5d7a3f1cc12f45e0028b090c0451"
			}"#).unwrap();

			EthereumRelay::confirm_relay_header_parcel_with_reason(relay_header_parcel, vec![]);

			let expect_account_id = EthereumBacking::account_id_try_from_bytes(
				&array_bytes::hex2bytes_unchecked("0xe44664996ab7b5d86c12e9d5ac3093f5b2efc9172cb7ce298cd6c3c51002c318"),
			).unwrap();

			assert_eq!(
				EthereumBacking::parse_token_redeem_proof(&test_receipt_proof_thing),
				Ok((expect_account_id, (true, 1234500000), 0)),
			);
		});
}

#[test]
fn verify_redeem_ring() {
	ExtBuilder::default()
		.build()
		.execute_with(|| {

			// https://ropsten.etherscan.io/tx/0x1d3ef601b9fa4a7f1d6259c658d0a10c77940fa5db9e10ab55397eb0ce88807d
			let test_receipt_proof_thing =  serde_json::from_str::<TestReceiptProofThing>(r#"{
				"header": {
					"difficulty": "0x1eba84a4",
					"extraData": "0xde830207028f5061726974792d457468657265756d86312e34312e30826c69",
					"gasLimit": "0x7a121d",
					"gasUsed": "0xe921d",
					"hash": "0xabf627ce77d9f92a40f34e3cace721c3f089000dae820d00d3e99314c263a0c3",
					"logsBloom": "0x00000000008000000000002000000004400000000000001000000000000000002000000000080000000010000040000000000001000000400000000000000000000000000000000011000008000000000210000000000000400000000000000000000000020000008104000000080800080000000000000000000030000000400004000000000001000000040000008000000002004000810010000000200000002000000000200000000000800000040010000400000200080000000000000000000402000000000200010000040000000001000001200800000000000020000000000000000000000000000010010000800000000080010000000004000000",
					"miner": "0xad87c0e80ab5e13f15757d5139cc6c6fcb823be3",
					"mixHash": "0xdeadf98810a6ccfb8d00e8f6bc7ad7f5d62d5a42760c0d9db8a549df76697704",
					"nonce": "0xbf7326c26c57c69c",
					"number": "0x8361d5",
					"parentHash": "0xd55ce7660d0161c38b34015ce5468e1661f1c77865f23415e246ac9ccf7b2b22",
					"receiptsRoot": "0xfdb6d2cdb6bc9e78711a008b2912e62db28de4520dfcd49bd6f7086718c5d0cb",
					"sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
					"size": "0xc0f",
					"stateRoot": "0xf108de6fa8fbf18e795cb3e1911d32e7d26178a69bb2f365662c8cba58bd7159",
					"timestamp": "0x5f50b3e0",
					"totalDifficulty": "0x6fa00a3a842464",
					"transactions": [],
					"transactionsRoot": "0x6cf40dbc3f8ce55ffc0f863a65ffd285da787b77af952c319e2577c5ab278a3a",
					"uncles": []
				},
				"receipt_proof": {
					"index": "0x12",
					"proof": "0xf90654f90651b873f871a08905d6a9a81124e73b632ff8e0ac638331d4aa0f89bc5b296b5132ab1e6db295a0296366ce16b627f71457cefa27e7cbd6aa3f13ce1e2225bb06236089d5363667808080808080a0c73f3d756add498b44b70ae5d5b917fcc8c3adb72f10cc5cd245a862d9a2a17d8080808080808080b873f871a039af78839760433d410ab11ef453e8656451a51575e0be71fa7a72b54bfc296aa098d3ce8768b102d89494e55dde408e28d1ec148affca70a955d2b30bd9fcf008a078eacce43297ddfa328b51d92ccd8666abf1df855cef7ab3b1f4dbd16874ff658080808080808080808080808080b90564f9056120b9055df9055a01830e921db9010000000000008000000000002000000004400000000000001000000000000000000000000000000000000010000000000000000000000000400000000000000000000000000000000010000008000000000010000000000000000000000000000000000000020000000104000000000800080000000000000000000010000000400000000000000001000000000000008000000002004000000010000000200000000000000000000000000000800000000000000000000200080000000000000000000002000000000000000000040000000001000000000800000000000020000000000000000000000000000010000000000000000080000000000000000000f9044ff89b94b52fbe2b925ab79a821b261c82c5ba0814aaa5e0f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000cc5e48beb33b83b8bd0d9d9a85a8f6a27c51f5c5a000000000000000000000000049262b932e439271d05634c32978294c7ea15d0ca00000000000000000000000000000000000000000000000001121d33597384000f89b94b52fbe2b925ab79a821b261c82c5ba0814aaa5e0f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000cc5e48beb33b83b8bd0d9d9a85a8f6a27c51f5c5a00000000000000000000000007f5b598827359939606b3525712fb124a1c7851da00000000000000000000000000000000000000000000000001bc16d674ec80000f87a94b52fbe2b925ab79a821b261c82c5ba0814aaa5e0f842a0cc16f5dbb4873280815c1ee09dbd06736cffcc184412cf7a71a0fdb75d397ca5a000000000000000000000000049262b932e439271d05634c32978294c7ea15d0ca00000000000000000000000000000000000000000000000001121d33597384000f89b94b52fbe2b925ab79a821b261c82c5ba0814aaa5e0f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa000000000000000000000000049262b932e439271d05634c32978294c7ea15d0ca00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000001121d33597384000f8fc9449262b932e439271d05634c32978294c7ea15d0cf863a0c9dcda609937876978d7e0aa29857cb187aea06ad9e843fd23fd32108da73f10a0000000000000000000000000b52fbe2b925ab79a821b261c82c5ba0814aaa5e0a0000000000000000000000000cc5e48beb33b83b8bd0d9d9a85a8f6a27c51f5c5b8800000000000000000000000000000000000000000000000001121d3359738400000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000020e44664996ab7b5d86c12e9d5ac3093f5b2efc9172cb7ce298cd6c3c51002c318f8fc94b52fbe2b925ab79a821b261c82c5ba0814aaa5e0f863a09bfafdc2ae8835972d7b64ef3f8f307165ac22ceffde4a742c52da5487f45fd1a0000000000000000000000000cc5e48beb33b83b8bd0d9d9a85a8f6a27c51f5c5a000000000000000000000000049262b932e439271d05634c32978294c7ea15d0cb8800000000000000000000000000000000000000000000000001121d3359738400000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000020e44664996ab7b5d86c12e9d5ac3093f5b2efc9172cb7ce298cd6c3c51002c318",
					"header_hash": "0xabf627ce77d9f92a40f34e3cace721c3f089000dae820d00d3e99314c263a0c3"
				},
				"mmr_proof": {
					"member_leaf_index": 8610261,
					"last_leaf_index": 8610261,
					"proof": [
						"0x36f3d834cbe12a5a20b063c432b88f5506bdce03b93fa3aa035a5d82fd50177c",
						"0x541f71c116b054b7cf0f35461b41abdc0bc6e461ae54862c8dc3af6b48742a35",
						"0x095f1b66aed2db73567706e227981454a80a442aa69b00aedaef787fd5401a78",
						"0x942cfd846d464575b520554dd07fd4b07ba2cb8bee6234530db1c1b3a69e1c50",
						"0x3174f9fdf5f7c9df6ac422a0a9e2aec05ccb7968bb1ff19b6cc0b64fbc930e77",
						"0x5624f44ff885dcdc971303281bb76c6b6a957a6cc2d244b30f736fc6220f9b89",
						"0xa3adc2ee02f7ceda7e63df8fb58094769afd3f7657c8f9f45cdc69d5c868b468",
						"0xe588926a1643dc04b197a7ed30dd47d42d35fdb01f7aa80b2e293b058c11c6a1",
						"0x25d7ac48be9565512424ef559b7e0ec7a91bfe9b57440913712a174e35eb47d8",
						"0xf4505f26b22ae59f5560003a68a66e8c07a9f77f212e05ea060018bd0acd1f55",
						"0xd55ce7660d0161c38b34015ce5468e1661f1c77865f23415e246ac9ccf7b2b22"
					]
				}
			}"#).unwrap();
			let test_receipt_proof_thing = (test_receipt_proof_thing.header, test_receipt_proof_thing.receipt_proof, test_receipt_proof_thing.mmr_proof);
			let relay_header_parcel = serde_json::from_str::<EthereumRelayHeaderParcel>(r#"{
				"header": {
					"difficulty": "0x1eba84a4",
					"extraData": "0x6c6f746f706f6f6c",
					"gasLimit": "0x7a1200",
					"gasUsed": "0x667f8a",
					"hash": "0xd04a94f4ec0a29f53b40fb13a660b680c8b66ccbb4e864a3727535f667a07bb1",
					"logsBloom": "0x00000000000000000000000000000000000000000000000000800000000000000000000000010000000000000000004000000000000000020000010000000000001000000000000000000008000000000001000000000000000000000000000000000000020000000000000000000800000000000000000000000010000000400000000000001000000000000000000000000000001000000000100000000000000000000000000000000000000000000000000000800000004000000080000000080002000008000000000040000000200200000000000002000000000020000000010000000000000000000000000000000000000000000000000000000000",
					"miner": "0x52351e33b3c693cc05f21831647ebdab8a68eb95",
					"mixHash": "0x46b0cc502bfed25a8700f53d6695eeed640b80218855b1dd5479c98a7b0e3e58",
					"nonce": "0x0011000003407250",
					"number": "0x8361d6",
					"parentHash": "0xabf627ce77d9f92a40f34e3cace721c3f089000dae820d00d3e99314c263a0c3",
					"receiptsRoot": "0x2bbd8af877b41e2cdff6e69dc100c69b061c874c3898e073ac24648ac9cd7d02",
					"sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
					"size": "0x195fa",
					"stateRoot": "0x20a368875c1aa9f46a7be4de7b470b92440684d0d74416b77ace846a31d57ce6",
					"timestamp": "0x5f50b3ef",
					"totalDifficulty": "0x6fa00a593ea908",
					"transactions": [],
					"transactionsRoot": "0xc6957c52dcac0eb2bda32765cc7c2b13406cf040021ea5caa5ba974d7a81fc95",
					"uncles": []
				},
				"parent_mmr_root": "0x95866493e3fd63b6a19c7815cc5cecaae57d5d7a3f1cc12f45e0028b090c0451"
			}"#).unwrap();

			EthereumRelay::confirm_relay_header_parcel_with_reason(relay_header_parcel, vec![]);

			let expect_account_id = EthereumBacking::account_id_try_from_bytes(
				&array_bytes::hex2bytes_unchecked("0xe44664996ab7b5d86c12e9d5ac3093f5b2efc9172cb7ce298cd6c3c51002c318"),
			).unwrap();
			let id1 = AccountId32::from([0; 32]);
			let ring_locked_before = EthereumBacking::pot::<Ring>();
			let _ = Ring::deposit_creating(&expect_account_id, 1);

			assert_ok!(EthereumBacking::redeem(
				Origin::signed(id1.clone()),
				RedeemFor::Token,
				test_receipt_proof_thing.clone()
			));
			assert_eq!(Ring::free_balance(&expect_account_id), 1234500000 + 1);

			let ring_locked_after = EthereumBacking::pot::<Ring>();
			assert_eq!(ring_locked_after + 1234500000, ring_locked_before);

			// shouldn't redeem twice
			assert_err!(
				EthereumBacking::redeem(Origin::signed(id1.clone()), RedeemFor::Token, test_receipt_proof_thing),
				<Error<Test>>::AssetAR,
			);
		});
}

#[test]
fn verify_redeem_kton() {
	ExtBuilder::default()
		.build()
		.execute_with(|| {
			// https://ropsten.etherscan.io/tx/0x2878ae39a9e0db95e61164528bb1ec8684be194bdcc236848ff14d3fe5ba335d
			// darwinia: 5FP2eFNSVxJzSrE3N2NEVFPhUU34VzYFD6DDtRXbYzTdwPn8
			// hex: 0x92ae5b41feba5ee68a61449c557efa9e3b894a6461c058ec2de45429adb44546
			// amount: 0.123456789123456789 KTON
			let test_receipt_proof_thing =  serde_json::from_str::<TestReceiptProofThing>(r#"{
				"header": {
					"difficulty": "0x1ec233bf",
					"extraData": "0x6c6f746f706f6f6c",
					"gasLimit": "0x7a1200",
					"gasUsed": "0x32c33",
					"hash": "0x5f80ee45d62872fa4b0dbf779a8eb380e166ac80616d05875dd3e80e5fc40839",
					"logsBloom": "0x0000000000800000000000000000000440000000000000100000000000000000000000000000000000001000000000000000000000000040000000000000000000000000000040001020000800000000001000000000000000000004000000000000000002000000010400000000080008000000000000000000001000000040000000000000000000000000000000c000000002004000000010000000200000000000000000000000000000800000000000000000000202080000000000000000000002000000000000000000040000000001000000000000000000000020000000000000000000000000010010000000000000000080000000000000000000",
					"miner": "0x52351e33b3c693cc05f21831647ebdab8a68eb95",
					"mixHash": "0xa7ea34046ebd043b4bca8836bc8968113d026d6c852b80a83a9b06db2db938e5",
					"nonce": "0x00118000012d2ccd",
					"number": "0x8361d9",
					"parentHash": "0x734ea7bd03f510e7dd0acc85a7ceb777d5d7d5ad5650785536fc09179a250143",
					"receiptsRoot": "0x9873421df4b9e11b174bc08e4d79d9a65032ba702ea8d3e0e6c6e9217d1cbf03",
					"sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
					"size": "0x533",
					"stateRoot": "0xabb0917ee898c71f3826d97415ff9161b37d03146b54e1c7d536fabb23352a5c",
					"timestamp": "0x5f50b403",
					"totalDifficulty": "0x6fa00ab57d94af",
					"transactions": [],
					"transactionsRoot": "0xd1c259805e50c5c4aa21b92f31d8a59f025f457a90a250ca516e8930d7bb05ec",
					"uncles": []
				},
				"receipt_proof": {
					"index": "0x4",
					"proof": "0xf90654f90651b853f851a0924e7317d57b9cb7ebf90321fdc9f800b94b64adbaae8da31dab0142e8c079ea80808080808080a0e58215be848c1293dd381210359d84485553000a82b67410406d183b42adbbdd8080808080808080b893f89180a0d1d9123dac06536f593ff89d28ac2373b3bc603fbee756e6054d6b2162e99337a01d2879f862c4f4f818f91e74fa43188c36a344c93132783006864e506a656076a0002cd3adf59d2aaa8313a0bbaa8fd411921077bfa1edcbe04018f7339bd273faa03bddfc128660298a289de46a9301b7f03cbe5364c22aedbc28f472bdbc318778808080808080808080808080b90564f9056120b9055df9055a0183032c33b901000000000000800000000000000000000440000000000000100000000000000000000000000000000000001000000000000000000000000040000000000000000000000000000040001020000800000000001000000000000000000004000000000000000002000000010400000000080008000000000000000000001000000040000000000000000000000000000000c000000002004000000010000000200000000000000000000000000000800000000000000000000202080000000000000000000002000000000000000000040000000001000000000000000000000020000000000000000000000000010010000000000000000080000000000000000000f9044ff89b941994100c58753793d52c6f457f189aa3ce9cee94f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000cc5e48beb33b83b8bd0d9d9a85a8f6a27c51f5c5a000000000000000000000000049262b932e439271d05634c32978294c7ea15d0ca00000000000000000000000000000000000000000000000000000703b4d2a5000f89b94b52fbe2b925ab79a821b261c82c5ba0814aaa5e0f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000cc5e48beb33b83b8bd0d9d9a85a8f6a27c51f5c5a00000000000000000000000007f5b598827359939606b3525712fb124a1c7851da00000000000000000000000000000000000000000000000001bc16d674ec80000f87a941994100c58753793d52c6f457f189aa3ce9cee94f842a0cc16f5dbb4873280815c1ee09dbd06736cffcc184412cf7a71a0fdb75d397ca5a000000000000000000000000049262b932e439271d05634c32978294c7ea15d0ca00000000000000000000000000000000000000000000000000000703b4d2a5000f89b941994100c58753793d52c6f457f189aa3ce9cee94f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa000000000000000000000000049262b932e439271d05634c32978294c7ea15d0ca00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000703b4d2a5000f8fc9449262b932e439271d05634c32978294c7ea15d0cf863a0c9dcda609937876978d7e0aa29857cb187aea06ad9e843fd23fd32108da73f10a00000000000000000000000001994100c58753793d52c6f457f189aa3ce9cee94a0000000000000000000000000cc5e48beb33b83b8bd0d9d9a85a8f6a27c51f5c5b8800000000000000000000000000000000000000000000000000000703b4d2a500000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000020e44664996ab7b5d86c12e9d5ac3093f5b2efc9172cb7ce298cd6c3c51002c318f8fc941994100c58753793d52c6f457f189aa3ce9cee94f863a09bfafdc2ae8835972d7b64ef3f8f307165ac22ceffde4a742c52da5487f45fd1a0000000000000000000000000cc5e48beb33b83b8bd0d9d9a85a8f6a27c51f5c5a000000000000000000000000049262b932e439271d05634c32978294c7ea15d0cb8800000000000000000000000000000000000000000000000000000703b4d2a500000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000020e44664996ab7b5d86c12e9d5ac3093f5b2efc9172cb7ce298cd6c3c51002c318",
					"header_hash": "0x5f80ee45d62872fa4b0dbf779a8eb380e166ac80616d05875dd3e80e5fc40839"
				},
				"mmr_proof": {
					"member_leaf_index": 8610265,
					"last_leaf_index": 8610265,
					"proof": [
						"0x36f3d834cbe12a5a20b063c432b88f5506bdce03b93fa3aa035a5d82fd50177c",
						"0x541f71c116b054b7cf0f35461b41abdc0bc6e461ae54862c8dc3af6b48742a35",
						"0x095f1b66aed2db73567706e227981454a80a442aa69b00aedaef787fd5401a78",
						"0x942cfd846d464575b520554dd07fd4b07ba2cb8bee6234530db1c1b3a69e1c50",
						"0x3174f9fdf5f7c9df6ac422a0a9e2aec05ccb7968bb1ff19b6cc0b64fbc930e77",
						"0x5624f44ff885dcdc971303281bb76c6b6a957a6cc2d244b30f736fc6220f9b89",
						"0xa3adc2ee02f7ceda7e63df8fb58094769afd3f7657c8f9f45cdc69d5c868b468",
						"0xe588926a1643dc04b197a7ed30dd47d42d35fdb01f7aa80b2e293b058c11c6a1",
						"0x25d7ac48be9565512424ef559b7e0ec7a91bfe9b57440913712a174e35eb47d8",
						"0xddce19308c3a42831e215c55aa42af46b09d98ccb2c48fc25a74aebc929f4b5d",
						"0x734ea7bd03f510e7dd0acc85a7ceb777d5d7d5ad5650785536fc09179a250143"
					]
				}
			}"#).unwrap();
			let test_receipt_proof_thing = (test_receipt_proof_thing.header, test_receipt_proof_thing.receipt_proof, test_receipt_proof_thing.mmr_proof);
			let relay_header_parcel = serde_json::from_str::<EthereumRelayHeaderParcel>(r#"{
				"header": {
					"difficulty": "0x1ec60c05",
					"extraData": "0x4d696e656420427920416e74506f6f6c",
					"gasLimit": "0x79f4ad",
					"gasUsed": "0xc847",
					"hash": "0x298b6e52435d4fa40fce031a73f4959e54514bafa6b861017175b17b52c57dbd",
					"logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000040000000000000040000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
					"miner": "0x903b52a3b21885fcc62afbed7c9ae4ed1423871e",
					"mixHash": "0x6ee0118099a229a341b525fcf1711b2a23965d074ba9ba2d1a13a356e70d11d7",
					"nonce": "0x4ce156b802047bea",
					"number": "0x8361da",
					"parentHash": "0x5f80ee45d62872fa4b0dbf779a8eb380e166ac80616d05875dd3e80e5fc40839",
					"receiptsRoot": "0x875709970cfb16e7cd2d9a1a2aabb2e900667e1ed4ed6553cc5348a09b8e869e",
					"sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
					"size": "0x32b",
					"stateRoot": "0x0a747c18e71216f010f330d456c4cfe262c6ccdb00b9fd1557ab8e078d87e543",
					"timestamp": "0x5f50b408",
					"totalDifficulty": "0x6fa00ad443a0b4",
					"transactions": [],
					"transactionsRoot": "0xaa9758d9753fe39172d8c6dee5d843d8877e4136ef1a9931e909dc71800a7ee3",
					"uncles": []
				},
				"parent_mmr_root": "0x26226df72727f8317e86e28503558fb02221baef2cec85816f75ae79fc250925"
			}"#).unwrap();

			EthereumRelay::confirm_relay_header_parcel_with_reason(relay_header_parcel, vec![]);

			let expect_account_id = EthereumBacking::account_id_try_from_bytes(
				&array_bytes::hex2bytes_unchecked("0xe44664996ab7b5d86c12e9d5ac3093f5b2efc9172cb7ce298cd6c3c51002c318"),
			).unwrap();
			// 0.123456789123456789 KTON
			assert_eq!(
				EthereumBacking::parse_token_redeem_proof(&test_receipt_proof_thing),
				Ok((expect_account_id.clone(), (false, 123400), 0)),
			);

			let id1 = AccountId32::from([0; 32]);
			let kton_locked_before = EthereumBacking::pot::<Kton>();
			let _ = Kton::deposit_creating(&expect_account_id, 1);

			assert_ok!(EthereumBacking::redeem(
				Origin::signed(id1.clone()),
				RedeemFor::Token,
				test_receipt_proof_thing.clone()
			));
			assert_eq!(Kton::free_balance(&expect_account_id), 123400 + 1);

			let kton_locked_after = EthereumBacking::pot::<Kton>();
			assert_eq!(kton_locked_after + 123400, kton_locked_before);

			// shouldn't redeem twice
			assert_err!(
				EthereumBacking::redeem(Origin::signed(id1.clone()), RedeemFor::Token, test_receipt_proof_thing),
				<Error<Test>>::AssetAR,
			);
		});
}

#[test]
fn verify_redeem_deposit() {
	ExtBuilder::default()
		.build()
		.execute_with(|| {
			// 1234ring -> 0.1234kton

			// _depositID    2
			// 0: address: 0xcC5E48BEb33b83b8bD0D9d9A85A8F6a27C51F5C5  _depositor
			// 1: uint128: 1001000000000000000000 _value
			// 2: uint128: 12 _months
			// 3: uint256: 1599125470 _startAt
			// 4: uint256: 1000 _unitInterest
			// 5: bool: false
			//  _data     0x92ae5b41feba5ee68a61449c557efa9e3b894a6461c058ec2de45429adb44546

			// transfer：https://ropsten.etherscan.io/tx/0x5a7004126466ce763501c89bcbb98d14f3c328c4b310b1976a38be1183d91919
			let test_receipt_proof_thing =  serde_json::from_str::<TestReceiptProofThing>(r#"{
				"header": {
					"difficulty": "0x1fe7a87b",
					"extraData": "0x6c6f746f706f6f6c",
					"gasLimit": "0x7a1200",
					"gasUsed": "0x732280",
					"hash": "0x202591d2a7bff469ec186e3583e37b9c4bce2db847612ff975180436b5a4a1f1",
					"logsBloom": "0x00000048240080400004204082080d00000800004000001001810000028001408040000140002800000020000404010014020000100300000000000000200000240000000120808100004008400000020083826000000000800020008000100000000024021842400000042048000820080004000008400000000010001880581090880302008080004001208220000000000363084002480080200200201800220080001800004000040009002000100840008a00408208000004c00881000f00000102000500004000100000070a408100c9844020001000100000030020000010020000021520080810020000000082002020000000400000002080000000",
					"miner": "0x52351e33b3c693cc05f21831647ebdab8a68eb95",
					"mixHash": "0x1548d3ecae87cb01cb142984086dc9f772b9d9094884269b1e3644ec108e52b5",
					"nonce": "0x0011800002104414",
					"number": "0x836295",
					"parentHash": "0x870d2655fe393a3d12f595bce56ce5115907af9735cc8de8d95c05e7467d1321",
					"receiptsRoot": "0x707af65a83888ce8d9696941a122d3429c0600fb09c4644ab2162b1382099928",
					"sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
					"size": "0x4eb3",
					"stateRoot": "0x6d63278b3c9dae252148948ddd0db13ee1f7c81dc557681db22e422d37d9abf1",
					"timestamp": "0x5f50bb28",
					"totalDifficulty": "0x6fa021beb333d5",
					"transactions": [],
					"transactionsRoot": "0xd5a01c26eeb8e826613e4da09ac06f305fab7d183a84d417559139db814e2a23",
					"uncles": []
				},
				"receipt_proof": {
					"index": "0x2e",
					"proof": "0xf9065ff9065cb8b3f8b1a00465eebe6e5de09530e54a14732f416c6dd3df3e3d4de7e224057775e176005fa0364264753139e9b26d4caa5550e780af82744f1fa0212fb4d944843f40941767a0d5e53b63048540c8faf6b8cb035d471603e21ed03641b2750fae5b6029968928a0a2c1de87659c963a8a8970108e0087f59b102253748e0655f60005fc5f21463780808080a0985911552c5e2f0c8f1d3b43d8c68cb6cd0e23292e7a01ed65865d9c35b5364c8080808080808080b90214f90211a09a09b69760a6f7754adb10479eed2baa872b4994161458511eda43e19ada21d1a0778f7b69876965bfc8363c672c21912ca5f92f93980999e1da19b9849c075d45a0c120f0350037e907148309c3a2e5b07bfe220e630f67c1bd7d834b40e0c6e484a0138d6d6f0e5bcf7a46b8881303caeb3bbbd3cb32d654c0294172d44d3fad3ad2a0e0665be49fab75e8c174394d55813a6fc460d64e396ef4881a55a44b89e1fae3a00227d0ab9af8d74eddbf2f8ee9bb66f7ba856ae09571f9a24272f88854d9a771a00b40ca0d746f1610bcd9d1733cdbb4a03a495cc03e6b36586e78b7f752bf8908a02c5ae2bf60a79068b949a1a5cc831f468e8092615aa61b9c8e42f21449bad981a0d6fb9b1a137c24ab6aeadfd96385eeeeebf93061285e3d2e72c5227532d2f50ba0f8206f39008acc6ce0b550424a79d05daabe982f12aaaa499ebf6165c271721ba07e1caebbd285e75cceecfa73f76dc0d5c9b3a4471d37249a1f0c8f9f9f08404aa044e197285d11b10d4d1db722bc28eb33904014c70e1f0a48dc2557be28ee836da0d2255e960373f9d0a8af01d7a2eaa2ef61d4626be9a2ea25b92cd00b7eb2d370a0ac6e37eb951f28e057c20f2be5ec4929b03f523d6fb7728701dea74be9f7c7cba06929256f0c8f74646539b0407b77c905451e1b74bc1f968a73b4c51b4889c537a0fa4f77e7a759b28b652a748dff3f136fa4ed34458fd7e212af8614235a14b27380b9038df9038a20b90386f90383018371c62eb9010000000000000000400000200000000000000000000000001000000000000000000000000140000000000000000400000000000000000000000000000000000000000000000000008000000008000000000000000000000000000000000000000000000000020000000000000000000800080000000000000000000010000000001000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000800008000000208000000000000000000000002000000000000000000040000000001000000000000000000020020000000000000000000080000000000000000000000000000000000000000000000f90278f87a94b52fbe2b925ab79a821b261c82c5ba0814aaa5e0f842a0cc16f5dbb4873280815c1ee09dbd06736cffcc184412cf7a71a0fdb75d397ca5a00000000000000000000000006ef538314829efa8386fc43386cb13b4e0a67d1ea000000000000000000000000000000000000000000000003643aa647986040000f89b94b52fbe2b925ab79a821b261c82c5ba0814aaa5e0f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa00000000000000000000000006ef538314829efa8386fc43386cb13b4e0a67d1ea00000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000003643aa647986040000f9015c946ef538314829efa8386fc43386cb13b4e0a67d1ef842a0e77bf2fa8a25e63c1e5e29e1b2fcb6586d673931e020c4e3ffede453b830fb12a0000000000000000000000000000000000000000000000000000000000000001eb90100000000000000000000000000cc5e48beb33b83b8bd0d9d9a85a8f6a27c51f5c5000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000005f50b7de00000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000003643aa64798604000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000020e44664996ab7b5d86c12e9d5ac3093f5b2efc9172cb7ce298cd6c3c51002c318",
					"header_hash": "0x202591d2a7bff469ec186e3583e37b9c4bce2db847612ff975180436b5a4a1f1"
				},
				"mmr_proof": {
					"member_leaf_index": 8610453,
					"last_leaf_index": 8610453,
					"proof": [
						"0x36f3d834cbe12a5a20b063c432b88f5506bdce03b93fa3aa035a5d82fd50177c",
						"0x541f71c116b054b7cf0f35461b41abdc0bc6e461ae54862c8dc3af6b48742a35",
						"0x095f1b66aed2db73567706e227981454a80a442aa69b00aedaef787fd5401a78",
						"0x942cfd846d464575b520554dd07fd4b07ba2cb8bee6234530db1c1b3a69e1c50",
						"0x3174f9fdf5f7c9df6ac422a0a9e2aec05ccb7968bb1ff19b6cc0b64fbc930e77",
						"0xf50c2f20115cfdc7ae6c3bf3b3bf42f386ce517310a9ae985da2ef2c9f72b54e",
						"0x4b2db3a5e7dafa1627b3ec6816bb6aa4b1212c5291ca1eeaa4f13a0e140fb814",
						"0x07d9c0ef21208dbc3ef29d44293b77811e1c4937cb4d3c099d7a66d3d692ab2f",
						"0xa733e5990271f7c5a68f159c23c58f5bc5fa5187b173697230ff1637077ce9df",
						"0x870d2655fe393a3d12f595bce56ce5115907af9735cc8de8d95c05e7467d1321"
					]
				}
			}"#).unwrap();
			let test_receipt_proof_thing = (test_receipt_proof_thing.header, test_receipt_proof_thing.receipt_proof, test_receipt_proof_thing.mmr_proof);
			let relay_header_parcel = serde_json::from_str::<EthereumRelayHeaderParcel>(r#"{
				"header": {
					"difficulty": "0x1fdfae91",
					"extraData": "0xde830207028f5061726974792d457468657265756d86312e34312e30826c69",
					"gasLimit": "0x7a121d",
					"gasUsed": "0x59ac42",
					"hash": "0x8ba804b2aab01defd95a69dffdcecedda6bbd422ec7ff51f0ae792cacfe7bf5c",
					"logsBloom": "0x00000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000600000000000000000008000000000000000000000000000000000000000000000000020000000000000000000800000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000010000000000000000020000000000000000000000020000000000000000000000000000000000000000000",
					"miner": "0xad87c0e80ab5e13f15757d5139cc6c6fcb823be3",
					"mixHash": "0x1a8ee4e5ebb33f10cfbe3a4a7df452aae8b8125199fc5dbf47eec3b39303f72f",
					"nonce": "0xbd5fbaa0aaf8f15b",
					"number": "0x836296",
					"parentHash": "0x202591d2a7bff469ec186e3583e37b9c4bce2db847612ff975180436b5a4a1f1",
					"receiptsRoot": "0x0b5260288bc3e9acad7bdc9e74b7f2d89c50ff9e8002ea6a338e74473a1c3a03",
					"sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
					"size": "0x6bc2",
					"stateRoot": "0x4f0682474b9c3826f17fce29206f0a00f105b30685d5213cf95a81c354384a68",
					"timestamp": "0x5f50bb4b",
					"totalDifficulty": "0x6fa021de92e266",
					"transactions": [],
					"transactionsRoot": "0x1f6ca6fecd61433b30a7ead60a20e685a5af66ccb14159d307b862086f96570d",
					"uncles": []
				},
				"parent_mmr_root": "0x0d378bc5ada4c0103f9e5a0ff623dc72d6e797963d4902c6fcbbba4f265fab74"
			}"#).unwrap();

			EthereumRelay::confirm_relay_header_parcel_with_reason(relay_header_parcel, vec![]);

			let ring_locked_before = EthereumBacking::pot::<Ring>();
			let expect_account_id = EthereumBacking::account_id_try_from_bytes(
				&array_bytes::hex2bytes_unchecked("0xe44664996ab7b5d86c12e9d5ac3093f5b2efc9172cb7ce298cd6c3c51002c318"),
			).unwrap();
			let id1 = AccountId32::from([0; 32]);
			let controller = AccountId32::from([1; 32]);
			let _ = Ring::deposit_creating(&expect_account_id, 1);

			assert_ok!(Call::from(<darwinia_staking::Call<Test>>::bond(
				controller.clone(),
				StakingBalance::RingBalance(1),
				RewardDestination::Controller,
				0,
			)).dispatch(Origin::signed(expect_account_id.clone())));
			assert_ok!(EthereumBacking::redeem(
				Origin::signed(id1.clone()),
				RedeemFor::Deposit,
				test_receipt_proof_thing.clone()
			));
			assert_eq!(Ring::free_balance(&expect_account_id), 1001000000000 + 1);

			let ring_locked_after = EthereumBacking::pot::<Ring>();
			assert_eq!(ring_locked_after + 1001000000000, ring_locked_before);

			let staking_ledger = Staking::ledger(&controller);
			assert_eq!(staking_ledger, Some(StakingLedger {
				stash: expect_account_id,
				active_ring: 1001000000001,
				active_deposit_ring: 1001000000000,
				deposit_items: vec![TimeDepositItem {
					value: 1001000000000,
					start_time: 1599125470000,
					expire_time: 1630229470000,
				}],
				ring_staking_lock: StakingLock { staking_amount: 1001000000001, unbondings: WeakBoundedVec::force_from(vec![], None) },
				..Default::default()
			}));

			// shouldn't redeem twice
			assert_err!(
				EthereumBacking::redeem(Origin::signed(id1.clone()), RedeemFor::Deposit, test_receipt_proof_thing),
				<Error<Test>>::AssetAR,
			);
		});

	ExtBuilder::default().mainnet().build().execute_with(|| {
		// https://etherscan.io/tx/0xca98697c807290118a04b61de42e3d51db93b4fcf5142b1726ecca5b8df9299b
			let proof_thing =  serde_json::from_str::<TestReceiptProofThing>(r#"{
				"header": {
					"baseFeePerGas": "0x68457361a",
					"difficulty": "0x1b3f3e029a33b4",
					"extraData": "0x626565706f6f6c2e6f72675f33501b",
					"gasLimit": "0x1c95111",
					"gasUsed": "0x1287164",
					"hash": "0x23b67a40cd26f6025f33b06f190a20ee8d8aa268253b264bc5ad32d1bd3a5ba6",
					"logsBloom": "0x3da7d9967d35d3479fe9ba75b1219a2391c65a3a9724daf96f5b21c6bf57e1a7598f0d6b427bc7b4632a58b9c22589690fd49c050b21ad94f23ec72271bdec37d7c358888131f72bdf63360e5a9464f8de75bb44e8644c692ecd15779af359a3b324c6d147ba9ba19e6eddbc93fafa7ab863bf7328f85460fb991eb29428a830cd0feced7e73fed2cc4d4c6ccdbf5a7677b69c17eb2206eb8f695275727f3c1ceffe413ff35079a29b3b4cd6b7279c135a727ce53933e6ee0177a7f35d3c8ec6b6ce8657fdbb62daae9ca195ca3b5ffeea4d3606bfca6a9e2d6e3ca7d4ef6bba28bdfd1e996d3e08f695143973b7e745db314be96b3890c18a1fdfbcecd7bcdf",
					"miner": "0x99c85bb64564d9ef9a99621301f22c9993cb89e3",
					"mixHash": "0x2c8eb7b1f7ce7f57fb05acfbbe61732572b859c21e79d67f0e43faada8996fda",
					"nonce": "0x02d0d017cbb63a70",
					"number": "0xc7048d",
					"parentHash": "0x3e1c193349bc7c9d108e803a080603842ce15027f89bf29f36eab0bcf743d543",
					"receiptsRoot": "0x845b96b4615ed1482939384713de1e93e8feafe89b4995ed8d3f3e460d463abc",
					"sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
					"size": "0x1eb2c",
					"stateRoot": "0x725e56d38866c278a57b79d3b0857cca7b0f5a51a2cbaa7e12b7680c072547d1",
					"timestamp": "0x611bb14f",
					"totalDifficulty": "0x629095211dd9df25f85",
					"transactions": [],
					"transactionsRoot": "0xc6468c1e120402ac22b11cb8f7e76a25da69a89e750f0bd9d976d9273f8f68e2",
					"uncles": []
				},
				"receipt_proof": {
					"index": "0x8f",
					"proof": "0xf907ecf907e9b90134f90131a0e4b8219da48d682b22a72a41aa0da90aafa380224b434f135bc97785dd6a0c27a09f570bbe96471738d100ec98352f6a064c296491ba9e972df66407d4975c513fa041c98c293f0ce3c60327bf643a1aa9698f28283804f64707d911f0841d0d1664a0d6f4767b428e637a470d4da98ad4cc70f6146723feb5e1bac43122553083c3eca0b3795afeda7df36555328b1340ffa20485123c38f176ee7ea7af5c885fd4debea0d3f5111aded3411f2cd41230d9cdbd4ee1aa83a3480c5a996fa05791c0d04260a08f3575ff75c5d2e4ce33fb1a773474cf285a0911bff975e632b40320f0cb4e30a0c84a1885dfdf14602c18e9f331bc48af8e5da4b15f4cec1ffbc56e83f2f7f8b0a01912da8f16557bf3167bfd76e33cb0215d5c62578c0837d594cc7e1f8e5d587c8080808080808080b853f851a07315dd9cb6b27742d1b5800c0c8a3e1ee9d2204d614ca86f7762dd61db5fdfbaa0dae9d839db7c350027fafbcd77bd89c8fed6051b1a9589768d5d05593e091a72808080808080808080808080808080b8b3f8b18080808080808080a0cae9903a937193475f2e55bbaaf8ac373f744c366dfc0ba1eda7f5d81954ecd0a0c690b57630fdd05a2e0e60fc9100c866d8b99bf6e3599a5935ecfa751c5d4e6ba03e5c10008c64cecefba06f2d081eaa9ca33571ba86d57f9c558189b68ed573d4a06eb854b1084e180d45e2795b02db5a37148cbf7e46987f8245a46db5997a9e12a08a511a0a6bf56fd435b0f5483645e0588f5c0ff3aaef1f9b8601283571d2d53280808080b90214f90211a0366dfb6f97b12150271974b64f5ac72ab8381a94edc7998e9a335be1faf92736a0f19bfd108569b42b1bcfabe64f72df8c546d618be07ea1993540175e66e70352a0f547d4032297d4d7938c9d812dbc05af4f37f547f527baab433b68a2f62f17bda0a9a2e5a53a6eee3602b09c16d82d848e14538c42333a7f0168afc2ac50ea170ba0f997f51f144c01870e1a98d44339524cfd16f37bf41bf9011d6686dc81db6f4ea02fb4546274332d2ff933f8c8bc9d1f5730fd944b6b3fdba8fb574ea558152fe1a091233cafc52969cd341f4de79a0d7aa7f477eae26b60398ffc56c99d8d54ee25a0b73cf6598fea78b92fb1e8b0c3c624f455b062beec91e1789be83e65655a6102a0e593488cff23f75c2a0f861d18bdf50a525d0b3406c34e67df993a174c0122f3a0c64eba43adadc9b3d864a4cd5489fd946b70df85411fa3b4a59ffc8cf255a48aa05fa00872c5645a26700168dabfb2d63acff38fc2a4dd4ab50d319d9d8717dacaa0d6417e34e6fb92b4747ac1a7de0bbfec5732dd45196988bf727b3c409f8095a0a065bf8b853beaa6a0e4f1e4f29cc30380c34b7803b7d96f9b1baa68738fa6ca40a0aa48b3db607237cec67d689a633d1139073917e5340be6799be105ff938448dea0791bc27243815b65b944b43a4a8815351a44dbb880712a57ff49a09f49b9aa66a0df912a05412950c52b8c5c129e077063f168f976f6a5b143a57d7763f5c39d6580b9038ef9038b20b9038702f903830183c49e0eb9010000000000000000000000200000000000000000000000001000000000000000000000000040000000000000000000000000000000010000000000002000000000000000000000000000000008000000400000000000000000000000000000000000000000020000001000000000000800080020000000000080000210000000000000000000000000000000000000000000000000000000000000000000200000040000000000000000000000000000000200000000000008000000000000000000000002000000000000000000000000000010000000000000000000000020000000000000000000020000000000000000000200000000000000000000000000f90278f87a949469d013805bffb7d3debe5e7839237e535ec483f842a0cc16f5dbb4873280815c1ee09dbd06736cffcc184412cf7a71a0fdb75d397ca5a0000000000000000000000000649fdf6ee483a96e020b889571e93700fbd82d88a000000000000000000000000000000000000000000000036026ddcd568f2ec000f89b949469d013805bffb7d3debe5e7839237e535ec483f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000649fdf6ee483a96e020b889571e93700fbd82d88a00000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000036026ddcd568f2ec000f9015c94649fdf6ee483a96e020b889571e93700fbd82d88f842a0e77bf2fa8a25e63c1e5e29e1b2fcb6586d673931e020c4e3ffede453b830fb12a000000000000000000000000000000000000000000000000000000000000000b7b901000000000000000000000000005ea0a235f426de9688dffe6ffc07cf99e32cc0990000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000005bfbfa6b00000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000036026ddcd568f2ec00000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000002008bca3ace88377f5a48a049dbe57815e283fb172f7a771d2756e46ea895b9243",
					"header_hash": "0x23b67a40cd26f6025f33b06f190a20ee8d8aa268253b264bc5ad32d1bd3a5ba6"
				},
				"mmr_proof": {
					"member_leaf_index": 13042829,
					"last_leaf_index": 13042829,
					"proof": [
						"0x8ab738686d2bd7f0f0340365ee5c23bdef99c571d1662607108903d646d0b332",
						"0xc0ab7f73f1a062b9255c2daf7d7ab8ab73f60e49fc1a76a5d733aa11c8121029",
						"0xe0d546baa24b8ea54d251e4713e5352da7c83fa291e7f56f910120facb8dd351",
						"0xc28c4e756a631cb05b1b8f1db10d2e982e7403bfea5a8a96466ae43382acee9f",
						"0xb8cca761d243d0a3b0d7c293f5af4a9659442dddb54295b6a809ec736c400549",
						"0x7c5da98ffa47781af7f53e8e62a1cbbd24a43a249a811cc6569759463600cf2f",
						"0xe72ecf58ff7ec596194d06ac170231910b9ea9fc2dfe8cc198138b6b9e3a5586",
						"0x7c4d9510cafefd0f7df834414c649e02b2f52f7f1a74bc1409341ff3b421695a",
						"0x93458f24d77b7ff1ae2ae4270ea94e1942da4e758ed81ab3af2016161d546e89",
						"0x3e1c193349bc7c9d108e803a080603842ce15027f89bf29f36eab0bcf743d543"
					]
				}
			}"#).unwrap();
			let proof_thing = (proof_thing.header, proof_thing.receipt_proof, proof_thing.mmr_proof);
			let relay_header_parcel = serde_json::from_str::<EthereumRelayHeaderParcel>(r#"{
				"header": {
					"baseFeePerGas": "0x6c2297d2a",
					"difficulty": "0x1b42a66a5a86fa",
					"extraData": "0x626565706f6f6c2e6f72675f3651d3",
					"gasLimit": "0x1c95111",
					"gasUsed": "0x1898506",
					"hash": "0xdacbf349fc2779f00184ac11222ec19d8164afdd3b9ab8d4b494214e7454546a",
					"logsBloom": "0x5dadf1f761eb7bb9f4eff277b6d3dabdd9c3d776e09c14bc65872dfafd45cb01e6fd7fddffdfd7f7fe8e5bb9f30b5fd36674b7db6b4bfbbd2fb27fa5cbb77a9b7ef41daecbb5f36ddbe7f55bb9f766e77eb0b8dbaffbb489be625f0e8ff275d19ede913b96bfafa977ec9cdc92192dcee26775efcb5e14f2beab7ef4b3083af845bee17f67a537fefd7d15588bcf8d7de51aaf9177e2f23b55787eecbdfb7fffaffce77a19d9a423964fcbd1b8e2991d56dedec776b35ffbcbe10f56da7f9d5c739b24eb735a4c5eba0dd0dbd94f79498fe3636aafeb1a95eadffce21ebfe314fb3d3fb93cea3d49acfd36f6b77deddead64ef296dd3b750ffee4ef8d2b677e7",
					"miner": "0x99c85bb64564d9ef9a99621301f22c9993cb89e3",
					"mixHash": "0xe367b6a9a7fe8e1bdc736e3d298dfafb2bfc9185dc03f3994640ee5c16d64bd3",
					"nonce": "0x4e3dadf03edc558f",
					"number": "0xc7048e",
					"parentHash": "0x23b67a40cd26f6025f33b06f190a20ee8d8aa268253b264bc5ad32d1bd3a5ba6",
					"receiptsRoot": "0x5e5c9b4c99cea889bedb83fee86d3b84117fa316856d6e3bb1249c9577475fe2",
					"sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
					"size": "0x17db0",
					"stateRoot": "0xb6562dd7f03d6e6da4f2f36bfd2a4d3d7a2e74ce530ebc107df20447a31ea732",
					"timestamp": "0x611bb153",
					"totalDifficulty": "0x629096d5484084ce67f",
					"transactions": [],
					"transactionsRoot": "0x7b6f5ca799e007bf064400d81b703d3ebe990d130e83d8b9a8ab054d37cddb5b",
					"uncles": []
				},
				"parent_mmr_root": "0x77cae76a5b7b63712275924bad81dc20147a85120586af351771cf19371cf9f0"
			}"#).unwrap();

			EthereumRelay::confirm_relay_header_parcel_with_reason(relay_header_parcel, vec![]);

			assert_eq!(EthereumBacking::parse_deposit_redeem_proof(&proof_thing).unwrap(), (
				183.into(),
				array_bytes::hex_into_unchecked("08bca3ace88377f5a48a049dbe57815e283fb172f7a771d2756e46ea895b9243"),
				15940787500000,
				1543240299,
				36,
				0,
			));
	});
}

#[test]
fn set_redeem_status_should_work() {
	ExtBuilder::default().build().execute_with(|| {
		assert_err!(
			EthereumBacking::redeem(
				Origin::signed(Default::default()),
				RedeemFor::Deposit,
				(
					Default::default(),
					EthereumReceiptProof {
						index: Default::default(),
						proof: Default::default(),
						header_hash: Default::default()
					},
					Default::default()
				),
			),
			EthereumRelayError::ConfirmedHeaderNE
		);

		assert_ok!(EthereumBacking::set_redeem_status(Origin::root(), false));

		assert_err!(
			EthereumBacking::redeem(
				Origin::signed(Default::default()),
				RedeemFor::Deposit,
				(
					Default::default(),
					EthereumReceiptProof {
						index: Default::default(),
						proof: Default::default(),
						header_hash: Default::default()
					},
					Default::default()
				),
			),
			<Error<Test>>::RedeemDis
		);

		assert_ok!(EthereumBacking::set_redeem_status(Origin::root(), true));

		assert_err!(
			EthereumBacking::redeem(
				Origin::signed(Default::default()),
				RedeemFor::Deposit,
				(
					Default::default(),
					EthereumReceiptProof {
						index: Default::default(),
						proof: Default::default(),
						header_hash: Default::default()
					},
					Default::default()
				),
			),
			EthereumRelayError::ConfirmedHeaderNE
		);
	});
}

#[test]
fn lock_should_work() {
	ExtBuilder::default().build().execute_with(|| {
		let account = Default::default();
		let e_account = Default::default();
		let init_balance = 100;
		let lock_balance = 10;
		let _ = Ring::deposit_creating(&account, init_balance);
		let _ = Kton::deposit_creating(&account, init_balance);
		let fee_account_id = EthereumBacking::fee_account_id();
		let fee_account_balance = Ring::free_balance(&fee_account_id);
		let module_account_id = EthereumBacking::account_id();
		let module_account_ring = Ring::free_balance(&module_account_id);
		let module_account_kton = Kton::free_balance(&module_account_id);
		let advanced_fee = <Test as Config>::AdvancedFee::get();

		assert_ok!(EthereumBacking::lock(
			Origin::signed(account.clone()),
			lock_balance,
			lock_balance,
			e_account
		));
		assert_eq!(
			Ring::free_balance(&account),
			init_balance - lock_balance - advanced_fee
		);
		assert_eq!(Kton::free_balance(&account), init_balance - lock_balance);
		assert_eq!(
			Ring::free_balance(&fee_account_id),
			fee_account_balance + advanced_fee
		);
		assert_eq!(
			Ring::free_balance(&module_account_id),
			module_account_ring + lock_balance
		);
		assert_eq!(
			Kton::free_balance(&module_account_id),
			module_account_kton + lock_balance
		);
	});
}

#[test]
fn lock_failed_rollback_transaction_should_work() {
	ExtBuilder::default().build().execute_with(|| {
		let account = Default::default();
		let e_account = Default::default();
		let init_balance = 10000;
		let lock_ring = RingLockLimit::get() - 1;
		let lock_kton = KtonLockLimit::get() + 1;
		let _ = Ring::deposit_creating(&account, init_balance);
		let _ = Kton::deposit_creating(&account, init_balance);
		let fee_account_id = EthereumBacking::fee_account_id();
		let fee_account_balance = Ring::free_balance(&fee_account_id);
		let module_account_id = EthereumBacking::account_id();
		let module_account_ring = Ring::free_balance(&module_account_id);
		let module_account_kton = Kton::free_balance(&module_account_id);
		let _advanced_fee = <Test as Config>::AdvancedFee::get();

		assert_noop!(
			EthereumBacking::lock(
				Origin::signed(account.clone()),
				lock_ring,
				lock_kton,
				e_account
			),
			<Error<Test>>::KtonLockLim
		);
		assert_eq!(Ring::free_balance(&account), init_balance);
		assert_eq!(Kton::free_balance(&account), init_balance);
		assert_eq!(Ring::free_balance(&fee_account_id), fee_account_balance);
		assert_eq!(Ring::free_balance(&module_account_id), module_account_ring);
		assert_eq!(Kton::free_balance(&module_account_id), module_account_kton);
	});
}

#[test]
fn lock_limit_should_work() {
	ExtBuilder::default().build().execute_with(|| {
		let account = Default::default();
		let lock_balance = 10_000;
		let _ = Ring::deposit_creating(&account, lock_balance);
		let _ = Kton::deposit_creating(&account, lock_balance);

		assert_err!(
			EthereumBacking::lock(
				Origin::signed(account.clone()),
				lock_balance,
				0,
				Default::default()
			),
			<Error<Test>>::RingLockLim
		);
		assert_err!(
			EthereumBacking::lock(
				Origin::signed(account.clone()),
				0,
				lock_balance,
				Default::default()
			),
			<Error<Test>>::KtonLockLim
		);
	});
}

#[test]
fn verify_signature_should_work() {
	assert!(EthereumBacking::verify_signature(
		&array_bytes::hex2array_unchecked("0x0806e7b411a8808c1384bd8abe3b506403981d3ece6b16cd29d3f2789eea1ab61635b3b971bf5584bdc70c42b2a4a2659b354dfc542943c030630168825976491c"),
		&array_bytes::hex2array_unchecked("0x71e2f60faf6c7264cca14fb1a01260a787b4d18039cd8cd680aaff1e118c711d"),
	 	&array_bytes::hex_into_unchecked("0x6aA70f55E5D770898Dd45aa1b7078b8A80AAbD6C")
	));
}

#[test]
fn verify_new_authorities() {
	ExtBuilder::default()
		.build()
		.execute_with(|| {
			// transfer：https://ropsten.etherscan.io/tx/0x652528b9421ecb495610a734a4ab70d054b5510dbbf3a9d5c7879c43c7dde4e9
			// shadow: https://testnet.shadow.darwinia.network/ethereum/receipt/0x652528b9421ecb495610a734a4ab70d054b5510dbbf3a9d5c7879c43c7dde4e9/9347302
			let test_receipt_proof_thing : TestReceiptProofThing =  serde_json::from_str(r#"{
				"header": {
					"difficulty": "0x214da52",
					"extraData": "0xd683010914846765746886676f312e3135856c696e7578",
					"gasLimit": "0x7a1200",
					"gasUsed": "0x2b0844",
					"hash": "0x3b921afa29be2c9ae2e3e31cb5c1a04a48b15d5b254fe34d1d03fa9c681453d3",
					"logsBloom": "0x00000004000000000000002000410000002000010000000010000000000000000001000000000000400000000000000000000000000000010040000000040008000100002000000000000048080000000008001000041400000100000800008000000000000000000000000000000050100000000000000008000210000000000400000000100000100000100000000080004000000000800000801000000000000100000000000400000080020000002000000008000002000000808408400000000002000000000008220000000000000100004000002000000000004040000800000402000028080000008101080000000000000010080000000000000000",
					"miner": "0x73c37cb411a618914be8953e18ba8ee5e2a5201b",
					"mixHash": "0xcc290d59c54f06baff608e7c45387f26aface811e45472b27595676c2e1f7717",
					"nonce": "0x0030cb83e3a11936",
					"number": "0x8ea0e5",
					"parentHash": "0xbe0b0035e8d59d89ebd8b9f96873eecdfb104079a7e6cf7b66c4baa8046a6af1",
					"receiptsRoot": "0x3746f4c68475ddb69adc64839e6346663a6306bffa1b91ceb252c72fcec54aab",
					"sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
					"size": "0x27e7",
					"stateRoot": "0xdb4214c17539e7cc33114aeffe81d2d97fb5fb89b1d17f594ca58051c71deaaa",
					"timestamp": "0x5fe97c7d",
					"totalDifficulty": "0x72dd05bde7bc12",
					"transactions": [],
					"transactionsRoot": "0xe72eb7f91f7d66fcb13503bca2036a7f0814de697b578dd4aba8cc61d90dc8cc",
					"uncles": []
				},
				"receipt_proof": {
					"index": "0x11",
					"proof": "0xf9033ff9033cb873f871a03400047859bb4e6c3bf07c4c133a5c8e7b9c4b33642991c982d8d4cb7edd8ac7a0da2adb936e17f66841cf55b682c7e7bfcb9050a0f21ee19757734aaf25ab4d7b808080808080a0bfc3b1906ab988733b1517e90630b95b19bf30354098e6684b7156501297574d8080808080808080b8b3f8b1a09958f935b9fabe67f402fa82185f61480626450b180df9b6bc188320979ca36da06f1fb447fb0d1f69f851ddee45edeb7af046f82f2c3afe4a2cbe73c993d5f1a6a069987a8a41de40954eda6205bbc2c468f50776c45e3cd7b304cc212f710c3596a000a88eebcd8ec74567fec3679c0cfc586199af70685ba605a2124e683897e7a4a05dca2c8b1ed714c26e6c810feb8349bf70ebd94e438b8b8dae0aa6c2f127db0c808080808080808080808080b9020ff9020c20b90208f90205018322c7b3b9010000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f8fbf8f994e4a2892599ad9527d76ce6e26f93620fa7396d85e1a091d6d149c7e5354d1c671fe15a5a3332c47a38e15e8ac0339b24af3c1090690fb8c000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000060129f002b1c0787ea72c31b2dc986e66911fe1b4d6dc16f83a1127f33e5a74c7d00000000000000000000000000000000000000000000000000000000000000020000000000000000000000006aa70f55e5d770898dd45aa1b7078b8a80aabd6c000000000000000000000000b34ca61ce3202315aae32e70f0101d938c0bd13d",
					"header_hash": "0x3b921afa29be2c9ae2e3e31cb5c1a04a48b15d5b254fe34d1d03fa9c681453d3"
				},
				"mmr_proof": {
					"member_leaf_index": 9347301,
					"last_leaf_index": 9347301,
					"proof": [
						"0x36f3d834cbe12a5a20b063c432b88f5506bdce03b93fa3aa035a5d82fd50177c",
						"0x890e2e9ae29833618ea413dd00b24a5af252a9b45b41a0da5bf8d545b547ceda",
						"0xaf3eaf80145b38d847bd7e6ebe2617ac3ea0b9413f8206d8a580f8921d4c97ef",
						"0x10b640f579ec4db3be9deba7e7f11090a558810aa3b428698b6b6cdbd1056beb",
						"0x87ef0abefc10fab9ec5427f62d5a9100ebd3c7655ddb6f1cc2d93258f586b1e5",
						"0xcca2dae99182514f7042d3724f3eb0a81da3222f8f25b2fe8d850c6b0a0b7679",
						"0xef43e7eccba4bba463dce8b0b511ad5c4ba483ff459121dc07832fb2cdbfd834",
						"0xff6377b2fba6b6e3ba395ce33403a72e3c9478e81710e727b31c0525e7de7920",
						"0xb94d80b26ec47716efe9c944ee3832bf9d9b32e8ffd37a874ce132425b3430df",
						"0xa014d1aa101ddb88b7716c43eebd832f644a3e70a90a9a4c9a79dd4cd926acef",
						"0xbe0b0035e8d59d89ebd8b9f96873eecdfb104079a7e6cf7b66c4baa8046a6af1"
					]
				}
			}"#).unwrap();
			let test_receipt_proof_thing = (test_receipt_proof_thing.header, test_receipt_proof_thing.receipt_proof, test_receipt_proof_thing.mmr_proof);
			// shadow: https://testnet.shadow.darwinia.network/ethereum/parcel/9347303
			let relay_header_parcel : EthereumRelayHeaderParcel = serde_json::from_str(r#"{
				"header": {
					"difficulty": "0x214551e",
					"extraData": "0xd883010913846765746888676f312e31342e37856c696e7578",
					"gasLimit": "0x7a1200",
					"gasUsed": "0x1f2f7",
					"hash": "0xff7fee9fc525b65013fd8c301ef23f5cb0d7db346659779e1c9ca6ff059c477f",
					"logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
					"miner": "0x1f403c619f4eec77a6bfe269a08a02232f21711b",
					"mixHash": "0x2f71ef591ae265503546ac7ab072263121b8f7be5b311ebf6c747da0eaea7187",
					"nonce": "0x28681773bd9ddc49",
					"number": "0x8ea0e6",
					"parentHash": "0x3b921afa29be2c9ae2e3e31cb5c1a04a48b15d5b254fe34d1d03fa9c681453d3",
					"receiptsRoot": "0xf7b961af50fa318daf979701cc586c92d8d38d87ebee92fbeb9a8fe18462e955",
					"sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
					"size": "0x466",
					"stateRoot": "0xe75a36f1f91659cd68b482fdc16ff1724feda1a2c5f4304a9d6df3b27f3cb91a",
					"timestamp": "0x5fe97c9b",
					"totalDifficulty": "0x72dd05bffc1130",
					"transactions": [],
					"transactionsRoot": "0xc3d56a07fd42e2895a5c2e9c72d20961ff7533ed0498ff39bf127ed24a338c03",
					"uncles": []
				},
				"parent_mmr_root": "0x7dca3788ae8401072026d5406c6e5d011e71baed3fefae1b5fd4cea01a3c3210"
			}"#).unwrap();

			EthereumRelay::confirm_relay_header_parcel_with_reason(relay_header_parcel, vec![]);

			assert_ok!(
				EthereumBacking::sync_authorities_change(
					Origin::signed(Default::default()),
					test_receipt_proof_thing.clone(),
				)
			);
			assert_err!(
				EthereumBacking::sync_authorities_change(
					Origin::signed(Default::default()),
					test_receipt_proof_thing,
				),
				<Error<Test>>::AuthoritiesChangeAR
			);
		});
}
